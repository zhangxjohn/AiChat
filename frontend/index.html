<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuD Chat</title>
    <!-- Custom CSS -->
    <link href="styles.css" rel="stylesheet">
    <!-- å¼•å…¥å›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <!-- Markdown ç›¸å…³åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.3/dist/purify.min.js"></script>
    <!-- GitHub Markdown æ ·å¼ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
    <!-- æ·»åŠ  highlight.js çš„æš—è‰²ä¸»é¢˜ CSS å’Œ JS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        /* æ·»åŠ è‡ªå®šä¹‰ Markdown æ ·å¼ */
        .markdown-body {
            background-color: transparent !important;
            color: inherit !important;
        }
        .markdown-body p {
            margin: 0 !important;
        }
        .markdown-body img {
            max-width: 100%;
            border-radius: 4px;
        }
        .markdown-body code {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 2px 4px;
            border-radius: 3px;
        }
        .markdown-body pre code {
            background-color: #f6f8fa;
            display: block;
            padding: 1em;
            overflow-x: auto;
        }
        /* ä»£ç å—æ ·å¼ */
        .markdown-body pre {
            background-color: #0d1117 !important;  /* GitHub Dark ä¸»é¢˜çš„èƒŒæ™¯è‰² */
            border-radius: 6px !important;
            margin: 8px 0 !important;
            padding: 12px !important;
            overflow-x: auto !important;
            border: 1px solid #30363d !important;  /* æ·»åŠ è¾¹æ¡† */
        }

        .markdown-body pre code {
            background: none !important;
            padding: 0 !important;
            border-radius: 0 !important;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace !important;
            font-size: 13px !important;
            line-height: 1.45 !important;
            white-space: pre !important;
            color: #e6edf3 !important;  /* ä»£ç æ–‡æœ¬é¢œè‰² */
        }

        /* è¡Œå†…ä»£ç æ ·å¼ */
        .markdown-body code {
            background-color: rgba(110, 118, 129, 0.4) !important;  /* æ·±è‰²èƒŒæ™¯ */
            border-radius: 4px !important;
            padding: 0.2em 0.4em !important;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace !important;
            font-size: 85% !important;
            color: #e6edf3 !important;  /* è¡Œå†…ä»£ç æ–‡æœ¬é¢œè‰² */
        }

        /* ç¡®ä¿ä»£ç å—åœ¨æ°”æ³¡ä¸­æ­£ç¡®æ˜¾ç¤º */
        .message-content pre {
            max-width: 100% !important;
            margin: 8px 0 !important;
        }

        /* è°ƒæ•´ä»£ç å—ä¸­çš„æ»šåŠ¨æ¡æ ·å¼ */
        .markdown-body pre::-webkit-scrollbar {
            height: 8px !important;
        }

        .markdown-body pre::-webkit-scrollbar-thumb {
            background-color: #30363d !important;  /* æ·±è‰²æ»šåŠ¨æ¡ */
            border-radius: 4px !important;
        }

        .markdown-body pre::-webkit-scrollbar-track {
            background-color: #0d1117 !important;  /* ä¸ä»£ç å—èƒŒæ™¯è‰²ç›¸åŒ */
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- ç”¨æˆ·åè¾“å…¥æ¨¡æ€æ¡† -->
        <div id="username-modal" class="modal">
            <div class="modal-content">
                <h1>åœ¨çº¿åä½œ</h1>
                <div class="subtitle">æ°¸ä¹…å…è´¹</div>
                <div class="input-group">
                    <div class="input-wrapper">
                        <input type="text" id="username-input" placeholder="è¾“å…¥ç”¨æˆ·å" maxlength="20">
                    </div>
                    <button onclick="joinChat()" id="join-button">åŠ å…¥èŠå¤©</button>
                </div>
                <div id="connection-status"></div>
            </div>
        </div>

        <!-- èŠå¤©ç•Œé¢ -->
        <div id="chat-container" style="display: none;">
            <!-- å·¦ä¾§é€šè®¯å½• -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="current-user">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=default" alt="avatar" class="avatar">
                        <div class="user-info">
                            <span class="username"></span>
                            <span class="status-text"></span>
                        </div>
                    </div>
                </div>
                <div class="search-box">
                    <div class="search-input-wrapper">
                        <i class="bi bi-search"></i>
                        <input type="text" id="contact-search" placeholder="æœç´¢" oninput="filterContacts()">
                    </div>
                </div>
                <div class="contact-tabs">
                    <button class="tab-btn active" onclick="switchTab('chats')">
                        <i class="bi bi-chat-dots-fill"></i>
                        <span>èŠå¤©</span>
                    </button>
                    <button class="tab-btn" onclick="switchTab('contacts')">
                        <i class="bi bi-person-lines-fill"></i>
                        <span>è”ç³»äºº</span>
                    </button>
                </div>
                <div class="member-list">
                    <!-- èŠå¤©åˆ—è¡¨ -->
                    <div id="chats-tab" class="tab-content active">
                        <!-- ç¾¤èŠåˆ—è¡¨ -->
                        <div class="list-section">
                            <div class="list-header">
                                <i class="bi bi-people-fill"></i>
                                <span>ç¾¤èŠ</span>
                                <span class="group-count"></span>
                            </div>
                            <ul id="groups">
                                <li class="member-item active" onclick="backToGroupChat()">
                                    <img src="https://api.dicebear.com/7.x/initials/svg?seed=LuD" alt="åœ¨çº¿åä½œç¾¤" class="member-avatar">
                                    <div class="member-info">
                                        <span class="member-name">åœ¨çº¿åä½œç¾¤</span>
                                        <div class="member-details">
                                            <span class="member-status">æ°¸ä¹…å…è´¹</span>
                                            <span class="online-time"></span>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        
                        <!-- æœ€è¿‘èŠå¤©åˆ—è¡¨ -->
                        <div class="list-section">
                            <div class="list-header">
                                <i class="bi bi-clock-history"></i>
                                <span>æœ€è¿‘èŠå¤©</span>
                            </div>
                            <ul id="recent-chats"></ul>
                        </div>
                    </div>

                    <!-- è”ç³»äººåˆ—è¡¨ -->
                    <div id="contacts-tab" class="tab-content" style="display: none;">
                        <!-- æˆ‘çš„ä¿¡æ¯ -->
                        <div class="list-section">
                            <div class="list-header">
                                <i class="bi bi-person-circle"></i>
                                <span>æˆ‘çš„ä¿¡æ¯</span>
                            </div>
                            <ul>
                                <li class="member-item" onclick="openProfileModal()">
                                    <img id="my-avatar" src="" alt="" class="member-avatar">
                                    <div class="member-info">
                                        <span id="my-username" class="member-name"></span>
                                        <div class="member-details">
                                            <span id="my-status" class="member-status">ç‚¹å‡»ç¼–è¾‘ä¸ªäººä¿¡æ¯</span>
                                        </div>
                                    </div>
                                    <i class="bi bi-pencil-square edit-icon"></i>
                                </li>
                            </ul>
                        </div>

                        <!-- åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ -->
                        <div class="list-section">
                            <div class="list-header">
                                <i class="bi bi-person-fill"></i>
                                <span>åœ¨çº¿è”ç³»äºº</span>
                                <span class="member-count"></span>
                            </div>
                            <ul id="users"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸­é—´èŠå¤©åŒºåŸŸ -->
            <div class="chat-area">
                <div class="chat-header">
                    <div class="chat-title">
                        <span>åœ¨çº¿åä½œç¾¤</span>
                        <span class="online-count"></span>
                    </div>
                </div>
                <div id="messages" class="message-list"></div>
                <div class="message-input-container">
                    <div class="message-toolbar">
                        <div class="toolbar-left">
                            <button onclick="insertMarkdown('**', '**')" title="ç²—ä½“"><i class="bi bi-type-bold"></i></button>
                            <button onclick="insertMarkdown('*', '*')" title="æ–œä½“"><i class="bi bi-type-italic"></i></button>
                            <button onclick="insertMarkdown('~~', '~~')" title="åˆ é™¤çº¿"><i class="bi bi-type-strikethrough"></i></button>
                            <button onclick="insertMarkdown('[', '](url)')" title="é“¾æ¥"><i class="bi bi-link-45deg"></i></button>
                            <button onclick="insertMarkdown('- ', '')" title="æ— åºåˆ—è¡¨"><i class="bi bi-list-ul"></i></button>
                            <button onclick="insertMarkdown('1. ', '')" title="æœ‰åºåˆ—è¡¨"><i class="bi bi-list-ol"></i></button>
                            <button onclick="insertMarkdown('> ', '')" title="å¼•ç”¨"><i class="bi bi-chat-square-quote"></i></button>
                            <button onclick="insertMarkdown('```\n', '\n```')" title="ä»£ç å—"><i class="bi bi-code-slash"></i></button>
                            <button onclick="openImageUpload()" title="æ’å…¥å›¾ç‰‡" class="image-upload-btn">
                                <i class="bi bi-image"></i>
                            </button>
                            <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                        </div>
                    </div>
                    <div class="editor-container">
                        <textarea id="message-input" class="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
                    </div>
                    <div class="message-footer">
                        <div class="footer-left">
                            <button onclick="openMentionPanel()" title="æåŠç”¨æˆ·" class="toolbar-btn">
                                <i class="bi bi-at"></i>
                            </button>
                            <button onclick="toggleEmojiPicker()" title="è¡¨æƒ…" class="toolbar-btn">
                                <i class="bi bi-emoji-smile"></i>
                            </button>
                            <button onclick="startVoiceMessage()" title="è¯­éŸ³" class="toolbar-btn">
                                <i class="bi bi-mic"></i>
                            </button>
                        </div>
                        <div class="footer-right">
                            <button onclick="insertNewline()" title="æ¢è¡Œ" class="toolbar-btn">
                                <i class="bi bi-arrow-return-left"></i>
                            </button>
                            <button class="send-btn" onclick="sendMessage()">
                                <i class="bi bi-send"></i>
                                å‘é€
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ä¿¡æ¯é¢æ¿ -->
            <div class="info-panel">
                <div class="panel-header">
                    <h3>ç¾¤èŠä¿¡æ¯</h3>
                </div>
                <div class="panel-content">
                    <div class="announcement">
                        <h4>
                            <i class="bi bi-megaphone"></i> ç¾¤å…¬å‘Š
                            <button onclick="openAnnouncementEditor()" class="edit-btn">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </h4>
                        <div class="announcement-content">
                            æ¬¢è¿åŠ å…¥åœ¨çº¿åä½œç¾¤ï¼è¿™é‡Œæ˜¯ä¸€ä¸ªå¼€æ”¾çš„äº¤æµç©ºé—´ï¼Œè¯·å¤§å®¶å‹å–„äº¤æµã€‚
                        </div>
                    </div>
                    <div class="group-info">
                        <h4>
                            <i class="bi bi-info-circle"></i> åŸºæœ¬ä¿¡æ¯
                            <button onclick="openGroupSettingsEditor()" class="edit-btn">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </h4>
                        <div class="info-item">
                            <span>ç¾¤åç§°ï¼š</span>
                            <span id="group-name">åœ¨çº¿åä½œç¾¤</span>
                        </div>
                        <div class="info-item">
                            <span>åˆ›å»ºæ—¶é—´ï¼š</span>
                            <span>2024-12-20</span>
                        </div>
                        <div class="info-item member-count">
                            <span>æˆå‘˜æ•°ï¼š</span>
                            <span class="count">0</span>
                        </div>
                    </div>
                    <div class="online-members">
                        <h4><i class="bi bi-person-check"></i> åœ¨çº¿æˆå‘˜</h4>
                        <div class="member-grid" id="online-members-grid"></div>
                    </div>
                </div>
            </div>

            <!-- æ·»åŠ ç¾¤è®¾ç½®ç¼–è¾‘æ¨¡æ€æ¡† -->
            <div id="group-settings-editor" class="modal" style="display: none;">
                <div class="modal-content">
                    <h2>ç¾¤èŠè®¾ç½®</h2>
                    <div class="input-group">
                        <label for="group-name-input">ç¾¤å</label>
                        <input type="text" id="group-name-input" maxlength="20" placeholder="è¾“å…¥ç¾¤åç§°">
                    </div>
                    <div class="button-group">
                        <button onclick="saveGroupSettings()" class="save-btn">ä¿å­˜</button>
                        <button onclick="closeGroupSettingsEditor()" class="cancel-btn">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ ä¸ªäººä¿¡æ¯ç¼–è¾‘æ¨¡æ€æ¡† -->
        <div id="profile-modal" class="modal" style="display: none;">
            <div class="modal-content profile-modal-content">
                <h2>ä¸ªäººä¿¡æ¯ï¿½ï¿½ï¿½ç½®</h2>
                <div class="profile-form">
                    <div class="profile-avatar-section">
                        <img id="current-avatar" class="profile-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=default" alt="å¤´åƒ">
                        <button class="change-avatar-btn" onclick="changeAvatar()">æ›´æ¢å¤´åƒ</button>
                    </div>
                    <div class="input-group">
                        <label for="profile-username">ç”¨æˆ·å</label>
                        <input type="text" id="profile-username" placeholder="è¾“å…¥æ–°çš„ç”¨æˆ·å">
                    </div>
                    <div class="input-group">
                        <label for="profile-status">ä¸ªæ€§ç­¾å</label>
                        <input type="text" id="profile-status" placeholder="è®¾ç½®ä½ çš„ä¸ªæ€§ç­¾å">
                    </div>
                    <div class="profile-buttons">
                        <button onclick="saveProfile()" class="save-btn">ä¿å­˜</button>
                        <button onclick="closeProfileModal()" class="cancel-btn">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ è¡¨æƒ…é€‰æ‹©å™¨é¢æ¿ -->
        <div id="emoji-picker" class="emoji-picker" style="display: none;">
            <div class="emoji-categories">
                <button class="active" onclick="switchEmojiCategory('recent')">æœ€è¿‘</button>
                <button onclick="switchEmojiCategory('smileys')">è¡¨æƒ…</button>
                <button onclick="switchEmojiCategory('animals')">åŠ¨ç‰©</button>
                <button onclick="switchEmojiCategory('food')">é£Ÿç‰©</button>
                <button onclick="switchEmojiCategory('activities')">æ´»åŠ¨</button>
                <button onclick="switchEmojiCategory('objects')">ç‰©å“</button>
            </div>
            <div class="emoji-list" id="emoji-list"></div>
        </div>

        <!-- æ·»åŠ æ¶ˆæ¯æœç´¢é¢æ¿ -->
        <div id="message-search-panel" class="message-search-panel" style="display: none;">
            <div class="search-header">
                <div class="search-input-wrapper">
                    <i class="bi bi-search"></i>
                    <input type="text" id="message-search-input" placeholder="æœç´¢æ¶ˆæ¯..." oninput="searchMessages()">
                </div>
                <button class="close-btn" onclick="closeMessageSearch()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="search-results" id="message-search-results"></div>
        </div>

        <!-- æ·»åŠ ç¾¤å…¬å‘Šç¼–è¾‘é¢æ¿ -->
        <div id="announcement-editor" class="modal" style="display: none;">
            <div class="modal-content">
                <h2>ç¼–è¾‘ç¾¤å…¬å‘Š</h2>
                <textarea id="announcement-text" rows="5" placeholder="è¾“å…¥ç¾¤å…¬å‘Šå†…å®¹..."></textarea>
                <div class="button-group">
                    <button onclick="saveAnnouncement()">ä¿å­˜</button>
                    <button onclick="closeAnnouncementEditor()" class="cancel-btn">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentUsername = '';
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 3;
        const RECONNECT_DELAY = 2000; // 2ç§’
        const statusDiv = document.getElementById('connection-status');
        const joinButton = document.getElementById('join-button');
        const bot = { name: 'å°åŠ©æ‰‹' };  // æ·»åŠ  bot å¯¹è±¡

        // è·å–WebSocketæœåŠ¡å™¨åœ°å€
        function getWebSocketUrl(username) {
            const encodedUsername = encodeURIComponent(username);
            return `ws://localhost:8000/ws/${encodedUsername}`;
        }

        function updateStatus(message, isError = false) {
            statusDiv.textContent = message;
            statusDiv.style.color = isError ? '#ff4444' : '#888';
            console.log(message);
        }

        async function checkServerHealth() {
            try {
                console.log('æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...');
                const healthUrl = 'http://localhost:8000/health';
                const response = await fetch(healthUrl, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    console.error('æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥å¤±è´¥:', response.status);
                    return false;
                }
                
                const data = await response.json();
                console.log('æœåŠ¡å™¨çŠ¶æ€:', data);
                return data.status === 'healthy';
            } catch (error) {
                console.error('æœåŠ¡å™¨æ£€æŸ¥å¤±è´¥:', error);
                return false;
            }
        }

        // æ·»åŠ  WebSocket è¿æ¥å‡½æ•°
        async function connectWebSocket(username) {
            try {
                const wsUrl = getWebSocketUrl(username);
                console.log('æ­£åœ¨è¿æ¥åˆ°:', wsUrl);
                
                ws = new WebSocket(wsUrl);
                
                return new Promise((resolve, reject) => {
                    const connectionTimeout = setTimeout(() => {
                        if (ws.readyState !== WebSocket.OPEN) {
                            ws.close();
                            reject(new Error('è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'));
                        }
                    }, 5000);

                    ws.onopen = () => {
                        clearTimeout(connectionTimeout);
                        console.log('WebSocketè¿æ¥æˆåŠŸ');
                        setupWebSocketHandlers();
                        resolve(ws);
                    };

                    ws.onerror = (error) => {
                        clearTimeout(connectionTimeout);
                        console.error('WebSocketè¿æ¥é”™è¯¯:', error);
                        reject(error);
                    };
                });
            } catch (error) {
                console.error('è¿æ¥é”™è¯¯:', error);
                throw error;
            }
        }

        // è®¾ç½® WebSocket äº‹ä»¶å¤„ç†å™¨
        function setupWebSocketHandlers() {
            ws.onclose = async (event) => {
                console.log('è¿æ¥å…³é—­:', event);
                
                let message = 'è¿æ¥å·²æ–­å¼€';
                if (event.reason) {
                    message += ': ' + event.reason;
                }
                
                if (event.code === 1008) {
                    message = 'ç”¨æˆ·åå·²è¢«ä½¿ç”¨';
                    updateStatus(message, true);
                    return;
                } else if (event.code === 1007) {
                    message = 'ç”¨æˆ·åæ— æ•ˆ';
                    updateStatus(message, true);
                    return;
                }
                
                updateStatus(message, true);
                
                // å°è¯•é‡æ–°è¿æ¥
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    updateStatus(`è¿æ¥æ–­å¼€ï¼Œ${RECONNECT_DELAY/1000}ç§’åå°è¯•ç¬¬${reconnectAttempts}æ¬¡é‡è¿...`);
                    
                    setTimeout(async () => {
                        try {
                            await connectWebSocket(currentUsername);
                            reconnectAttempts = 0;
                            updateStatus('é‡æ–°è¿æ¥æˆåŠŸï¼');
                        } catch (error) {
                            console.error('é‡è¿å¤±è´¥:', error);
                            updateStatus('é‡è¿å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', true);
                        }
                    }, RECONNECT_DELAY);
                } else {
                    updateStatus('å¤šæ¬¡é‡è¿å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', true);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocketé”™è¯¯:', error);
                updateStatus('è¿æ¥é”™è¯¯', true);
            };

            ws.onmessage = (event) => {
                try {
                    console.log('æ”¶åˆ°æ¶ˆæ¯:', event.data);
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (error) {
                    console.error('æ¶ˆæ¯å¤„ç†é”™è¯¯:', error);
                }
            };
        }

        // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
        function saveUserInfoToLocal() {
            const userInfo = {
                username: currentUsername,
                status: document.querySelector('.status-text').textContent,
                avatar: document.querySelector('.current-user .avatar').src
            };
            localStorage.setItem('userInfo', JSON.stringify(userInfo));
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ç”¨æˆ·ä¿¡æ¯
        function loadUserInfoFromLocal() {
            const savedInfo = localStorage.getItem('userInfo');
            if (savedInfo) {
                return JSON.parse(savedInfo);
            }
            return null;
        }

        // ä¿®æ”¹ joinChat å‡½æ•°
        async function joinChat() {
            const usernameInput = document.getElementById('username-input');
            const username = usernameInput.value.trim();
            
            if (!username) {
                updateStatus('è¯·è¾“å…¥ç”¨æˆ·å', true);
                return;
            }

            if (username.length > 20) {
                updateStatus('ç”¨æˆ·åä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦', true);
                return;
            }

            if (!/^[\u4e00-\u9fa5_a-zA-Z0-9]+$/.test(username)) {
                updateStatus('ç”¨æˆ·ååªèƒ½åŒ…å«ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—å’Œä¸‹åˆ’çº¿', true);
                return;
            }

            joinButton.disabled = true;
            updateStatus('æ­£åœ¨è¿æ¥...');

            try {
                if (ws) {
                    ws.close();
                    ws = null;
                }

                await connectWebSocket(username);
                
                currentUsername = username;
                
                // åŠ è½½ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯
                const savedInfo = localStorage.getItem(username);
                if (savedInfo) {
                    const userInfo = JSON.parse(savedInfo);
                    // æ¢ï¿½ï¿½å¤´åƒ
                    if (userInfo.avatar) {
                        document.querySelector('.current-user .avatar').src = userInfo.avatar;
                        document.getElementById('my-avatar').src = userInfo.avatar;
                        document.getElementById('current-avatar').src = userInfo.avatar;
                    }
                    // æ¢å¤ä¸ªæ€§ç­¾å
                    if (userInfo.status) {
                        document.querySelector('.status-text').textContent = userInfo.status;
                        document.getElementById('my-status').textContent = userInfo.status;
                    }
                } else {
                    // å¦‚æœæ˜¯æ–°ç”¨æˆ·ï¼Œåˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯
                    const initialInfo = {
                        username: username,
                        avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${username}`,
                        status: 'ç‚¹å‡»ç¼–è¾‘ä¸ªäººä¿¡æ¯'
                    };
                    localStorage.setItem(username, JSON.stringify(initialInfo));
                }
                
                // æ›´æ–°é¢æ˜¾ç¤º
                document.querySelector('.username').textContent = username;
                document.getElementById('my-username').textContent = username;
                
                // éšè—ç™»å½•æ¨¡æ€æ¡†ï¼Œæ˜¾ç¤ºèŠå¤©ç•Œé¢
                document.getElementById('username-modal').style.display = 'none';
                document.getElementById('chat-container').style.display = 'flex';
                
                console.log('è¿æ¥æˆåŠŸ');
                updateStatus('è¿æ¥æˆåŠŸï¼');
                
            } catch (error) {
                console.error('è¿æ¥é”™è¯¯:', error);
                updateStatus(error.message || 'è¿æ¥é”™è¯¯', true);
                joinButton.disabled = false;
            }
        }

        // ä¿®æ”¹ handleMessage å‡½æ•°
        function handleMessage(data) {
            console.log('æ”¶åˆ°æ¶ˆæ¯:', data);
            switch (data.type) {
                case 'users':
                    updateUserList(data.users);
                    break;
                case 'message':
                    // å¦‚æœä¸æ˜¯è‡ªå·±å‘çš„æ¶ˆæ¯æ‰æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
                    if (data.username !== currentUsername) {
                        addMessage(data);
                    }
                    if (data.isPrivate) {
                        updateChatHeader(data.from === currentUsername ? data.to : data.from);
                    }
                    notifyNewMessage(data);
                    break;
                case 'system':
                    addSystemMessage(data);
                    break;
                case 'private_message':
                    // å¦‚æœä¸æ˜¯è‡ªå·±å‘çš„æ¶ˆæ¯æ‰æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
                    if (data.from !== currentUsername) {
                        addMessage({
                            ...data,
                            username: data.from,
                            isPrivate: true
                        });
                    }
                    updateChatHeader(data.from === currentUsername ? data.to : data.from);
                    updateRecentChats(data.from === currentUsername ? data.to : data.from);
                    notifyNewMessage(data);
                    break;
                case 'recall':
                    handleRecalledMessage(data);
                    break;
                case 'status_change':
                    updateUserStatus(data.username, data.status);
                    break;
                case 'image':
                    addImageMessage(data);
                    break;
                case 'file':
                    addFileMessage(data);
                    break;
                case 'announcement':
                    updateAnnouncement(data.content);
                    break;
                case 'group_settings':
                    updateGroupSettings(data);
                    break;
            }
        }

        // ä¿®æ”¹ sendMessage å‡½æ•°ï¼Œæ·»åŠ å›¾ç‰‡æ¶ˆæ¯å¤„ç†
        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const content = messageInput.value.trim();
            
            if (!content) return;
            
            console.log('å‡†å¤‡å‘é€æ¶ˆæ¯:', content);
            
            if (!ws) {
                console.error('WebSocketæœªåˆå§‹åŒ–');
                showToast('è¿æ¥å·²æ–­å¼€ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            if (ws.readyState !== WebSocket.OPEN) {
                console.error('WebSocketæœªè¿æ¥ï¼ŒçŠ¶æ€:', ws.readyState);
                showToast('è¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨å°è¯•é‡æ–°è¿æ¥...');
                return;
            }
            
            const currentChat = document.querySelector('.chat-title span').textContent;
            const isPrivateChat = currentChat !== 'åœ¨çº¿åä½œç¾¤';

            // æ£€æŸ¥æ˜¯å¦åŒ…å«å›¾ç‰‡
            const imageMatch = content.match(/!\[.*?\]\((data:image\/[^;]+;base64,[^)]+)\)/);
            if (imageMatch) {
                // å‘é€å›¾ç‰‡æ¶ˆæ¯
                const message = {
                    type: 'image',
                    content: imageMatch[1],
                    isPrivate: isPrivateChat,
                    to: isPrivateChat ? currentChat : undefined
                };
                ws.send(JSON.stringify(message));
                
                // æœ¬åœ°æ˜¾ç¤ºå›¾ç‰‡
                addImageMessage({
                    username: currentUsername,
                    content: imageMatch[1],
                    timestamp: new Date().toLocaleTimeString()
                });
            } else {
                // å‘é€æ™®é€šæ–‡æœ¬æ¶ˆæ¯
                const message = {
                    type: 'message',
                    content: content,
                    isPrivate: isPrivateChat,
                    to: isPrivateChat ? currentChat : undefined
                };
                ws.send(JSON.stringify(message));
                
                // æœ¬åœ°æ˜¾ç¤ºæ¶ˆæ¯
                addMessage({
                    username: currentUsername,
                    content: content,
                    timestamp: new Date().toLocaleTimeString(),
                    isPrivate: isPrivateChat,
                    to: isPrivateChat ? currentChat : undefined
                });
            }
            
            // æ¸…ï¿½ï¿½ï¿½è¾“å…¥æ¡†
            messageInput.value = '';
        }

        // é‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('message-input');
            const sendButton = document.querySelector('.send-btn');
            
            // ç§»é™¤æ‰€æœ‰å·²å­˜åœ¨çš„äº‹ä»¶ç›‘å¬å™¨
            messageInput.replaceWith(messageInput.cloneNode(true));
            sendButton.replaceWith(sendButton.cloneNode(true));
            
            // é‡æ–°è·å…ƒç´ 
            const newMessageInput = document.getElementById('message-input');
            const newSendButton = document.querySelector('.send-btn');
            
            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            newMessageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            newSendButton.addEventListener('click', sendMessage);
        });

        // æ·»åŠ æ¶ˆæ¯å†å²å­˜å‚¨å¯¹è±¡
        const messageHistory = {
            group: [], // ç¾¤èŠæ¶ˆæ¯å†å²
            private: {} // ç§èŠæ¶ˆæ¯å†å²æ ¼å¼: { username: [] }
        };

        // ä¿®æ”¹ addMessage å‡½æ•°
        function addMessage(data) {
            console.log('æ·»åŠ æ¶ˆæ¯:', data);
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${data.username === currentUsername ? 'own' : 'other'}`;
            
            // æ·»åŠ æ—¶é—´æˆ³
            const lastMessage = messages.lastElementChild;
            if (!lastMessage || shouldShowTimestamp(lastMessage, data.timestamp)) {
                const timeDiv = document.createElement('div');
                timeDiv.className = 'timestamp';
                timeDiv.textContent = data.timestamp;
                messages.appendChild(timeDiv);
            }
            
            // ä½¿ç”¨ marked è§£æ Markdownï¼Œç”¨ DOMPurify æ¸…ç† HTML
            const parsedContent = marked.parse(data.content);
            const sanitizedContent = DOMPurify.sanitize(parsedContent);
            
            // æ„å»ºæ¶ˆæ¯å†…å®¹
            messageDiv.innerHTML = `
                <div class="message-header">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${data.username}" 
                         alt="${data.username}" class="message-avatar">
                    <span class="username">${data.username === currentUsername ? '' : data.username}</span>
                </div>
                <div class="message-content markdown-body">
                    ${sanitizedContent}
                </div>
            `;
            
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
            
            // ä¿å­˜æ¶ˆæ¯åˆ°å†å²è®°å½•
            const currentChat = document.querySelector('.chat-title span').textContent;
            if (currentChat === 'åœ¨çº¿åä½œç¾¤') {
                messageHistory.group.push(data);
            } else {
                if (!messageHistory.private[currentChat]) {
                    messageHistory.private[currentChat] = [];
                }
                messageHistory.private[currentChat].push(data);
            }
        }

        // ä¿®æ”¹ backToGroupChat å‡½æ•°
        function backToGroupChat() {
            // ç§»é™¤ç§èŠæ ·å¼
            const chatArea = document.querySelector('.chat-area');
            chatArea.classList.remove('private-chat');
            chatArea.style.width = ''; // æ¢å¤é»˜è®¤å®½åº¦
            
            // æ˜¾ç¤ºå³ä¾§ç¾¤èŠä¿¡æ¯é¢æ¿
            document.querySelector('.info-panel').style.display = '';
            
            updateChatHeader('åœ¨çº¿åä½œç¾¤');
            
            // æ¸…ç©ºå¹¶æ¢å¤ç¾¤èŠæ¶ˆæ¯
            document.getElementById('messages').innerHTML = '';
            messageHistory.group.forEach(msg => {
                addMessage(msg);
            });
        }

        // ä¿®æ”¹ updateChatHeader å‡½æ•°
        function updateChatHeader(targetName) {
            const chatTitle = document.querySelector('.chat-title span');
            chatTitle.textContent = targetName;
        }

        // ä¿®æ”¹ updateMyInfo å‡½æ•°
        function updateMyInfo() {
            if (currentUsername) {
                const myAvatar = document.getElementById('my-avatar');
                const sidebarAvatar = document.querySelector('.current-user .avatar');
                const myUsername = document.getElementById('my-username');
                const myStatus = document.getElementById('my-status');
                const sidebarUsername = document.querySelector('.current-user .user-info .username');
                const sidebarStatus = document.querySelector('.current-user .user-info .status-text');
                
                const avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUsername}`;
                myAvatar.src = avatarUrl;
                sidebarAvatar.src = avatarUrl;
                myAvatar.alt = currentUsername;
                sidebarAvatar.alt = currentUsername;
                
                myUsername.textContent = currentUsername;
                sidebarUsername.textContent = currentUsername;
                
                const status = localStorage.getItem('userStatus') || 'ç‚¹å‡»ç¼–è¾‘ä¸ªäººä¿¡æ¯';
                myStatus.textContent = status;
                sidebarStatus.textContent = status;
            }
        }

        // ä¿®æ”¹ updateUserList å‡½æ•°
        function updateUserList(users) {
            const userList = document.getElementById('users');
            const filteredUsers = users.filter(user => user !== currentUsername);
            
            // ç”Ÿæˆç”¨æˆ·åˆ—è¡¨HTML
            userList.innerHTML = filteredUsers.map(user => {
                const userStatus = localStorage.getItem(`userStatus_${user}`) || '';
                return `
                    <li class="member-item" onclick="startPrivateChat('${user}')">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${user}" alt="${user}" class="member-avatar">
                        <div class="member-info">
                            <span class="member-name">${user}</span>
                            <div class="member-details">
                                <span class="member-status">${userStatus || 'åœ¨çº¿'}</span>
                                <span class="online-time">åˆšåˆšæ´»è·ƒ</span>
                            </div>
                        </div>
                    </li>
                `;
            }).join('');
            
            // æ›´æ–°æˆå‘˜æ•°é‡
            updateMemberCount(users);
            
            // æ›´æ–°å½“å‰ç”¨æˆ·æ˜¾ç¤º
            updateMyInfo();
            
            // æ›´æ–°æœ€è¿‘èŠå¤©åˆ—è¡¨
            updateRecentChats();
        }

        // ä¿®æ”¹ startPrivateChat å‡½æ•°
        function startPrivateChat(username) {
            if (username === currentUsername) return;
            
            // æ›´æ–°èŠå¤©æ ‡é¢˜
            updateChatHeader(username);
            
            // åˆ‡æ¢åˆ°èŠå¤©æ ‡ç­¾é¡µ
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(t => t.classList.remove('active'));
            document.querySelector('.tab-btn[onclick="switchTab(\'chats\')"]').classList.add('active');
            
            // æ˜¾ç¤ºèŠå¤©åŒºåŸŸ
            document.getElementById('chats-tab').style.display = 'block';
            document.getElementById('contacts-tab').style.display = 'none';
            
            // æ·»åŠ ç§èŠæ ·å¼
            const chatArea = document.querySelector('.chat-area');
            chatArea.classList.add('private-chat');
            
            // éšè—å³ä¾§ç¾¤èŠä¿¡æ¯é¢æ¿
            document.querySelector('.info-panel').style.display = 'none';
            // è°ƒæ•´èŠå¤©åŒºåŸŸå®½åº¦
            chatArea.style.width = 'calc(100% - 300px)';
            
            // æ¸…ç©ºæ¶ˆæ¯åˆ—è¡¨
            document.getElementById('messages').innerHTML = '';
            
            // æ¢å¤å†å²æ¶ˆæ¯
            if (messageHistory.private[username]) {
                messageHistory.private[username].forEach(msg => {
                    addMessage(msg);
                });
            } else {
                // å¦‚æœæ²¡æœ‰å†å²æ¶ˆæ¯ï¼Œæ˜¾ç¤ºç³»ç»Ÿæç¤º
                addSystemMessage({
                    content: `å¼€å§‹ä¸ ${username} çš„ç§èŠ`
                });
            }

            // å¦‚æœæ˜¯å°åŠ©æ‰‹ï¼Œå‘é€ä¸€ä¸ªåˆå§‹æ¶ˆï¿½ï¿½åˆ°ç«¯
            if (username === 'å°åŠ©æ‰‹' && (!messageHistory.private[username] || messageHistory.private[username].length === 0)) {
                const message = {
                    type: 'message',
                    content: 'ä½ å¥½',
                    isPrivate: true,
                    to: username
                };
                
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(message));
                }
            }
            
            // æ›´æ–°æœ€è¿‘èŠå¤©åˆ—è¡¨
            updateRecentChats(username);
        }

        function addSystemMessage(data) {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.innerHTML = `
                <div class="message-content">${data.content}</div>
            `;
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function shouldShowTimestamp(lastMessage, newTimestamp) {
            // å¦‚æœæœ€åä¸€æ¡æ¶ˆæ¯æ˜¯ç³»ç»Ÿæ¶ˆæ¯ï¼Œæ€»æ˜¯æ˜¾ç¤ºæ—¶é—´æˆ³
            if (lastMessage.classList.contains('system')) {
                return true;
            }
            
            // ï¿½ï¿½ï¿½æœ€åä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³
            const lastTimestamp = lastMessage.querySelector('.timestamp')?.textContent;
            if (!lastTimestamp) {
                return true;
            }
            
            // å¦‚æœæ—¶é—´é—´éš”è¶…è¿‡5é’Ÿï¼Œæ˜¾ç¤ºæ–°çš„æ—¶é—´æˆ³
            const lastTime = parseTime(lastTimestamp);
            const newTime = parseTime(newTimestamp);
            return (newTime - lastTime) > 5 * 60 * 1000;
        }

        function parseTime(timeStr) {
            const [hours, minutes, seconds] = timeStr.split(':').map(Number);
            const now = new Date();
            now.setHours(hours, minutes, seconds);
            return now.getTime();
        }

        // ä¿®æ”¹æ¶ˆæ¯è¾“å…¥æ¡†çš„å›è½¦é”®å¤„ç†
        document.getElementById('message-input').addEventListener('keydown', (e) => {
            // å¦‚æœ @ é¢æ¿æ˜¾ç¤ºä¸­ï¼ŒEnter é”®ç”¨äºé€‰æ‹©ç”¨æˆ·
            const mentionPanel = document.querySelector('.mention-panel');
            if (mentionPanel && mentionPanel.style.display !== 'none') {
                if (e.key === 'Enter' || e.key === 'Tab') {
                    e.preventDefault();
                    e.stopPropagation();  // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    const selectedItem = mentionPanel.querySelector('.mention-item.selected');
                    if (selectedItem) {
                        insertMention(selectedItem.dataset.username);
                    }
                    return false;  // é˜»æ­¢é»˜è®¤è¡Œä¸º
                }
            } else if (e.key === 'Enter' && !e.shiftKey) {
                // åªæœ‰åœ¨ @ é¢æ¿ä¸æ˜¾ç¤ºæ—¶ï¼Œæ‰å‘é€æ¶ˆæ¯
                e.preventDefault();
                sendMessage();
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨èšç„¦ç”¨æˆ·åè¾“å…¥æ¡†
        window.onload = async () => {
            document.getElementById('username-input').focus();
            
            try {
                const isHealthy = await checkServerHealth();
                if (isHealthy) {
                    updateStatus('æœåŠ¡å™¨å·²å°±ç»ªï¼Œè¯·å…¥ç”¨æˆ·åå¹¶ç‚¹å‡»åŠ å…¥èŠå¤©');
                } else {
                    updateStatus('æœåŠ¡å™¨æœªå°±ç»ªï¼Œè¯·ç¨åè¯•', true);
                }
            } catch (error) {
                updateStatus('æ— æ³•è¿æœåŠ¡å™¨è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', true);
            }

            // åˆåŒ– @ æé†’åŠŸèƒ½
            setupMentionFeature();
        };

        // æ·»åŠ æ›´æ–°åœ¨çº¿äººæ•°çš„å‡½æ•°
        function updateMemberCount(users) {
            const filteredUsers = users.filter(user => user !== 'å°åŠ©æ‰‹');
            const total = filteredUsers.length;
            const online = filteredUsers.length; // ç›®å‰åœ¨çº¿äººæ•°ç­‰äºæ€»äººæ•°
            
            // æ›´æ–°ç¾¤ä¿¡æ¯ä¸­çš„æˆå‘˜æ•°
            document.querySelector('.member-count .count').textContent = `${total}`;
            // æ›´æ–°ç¾¤èŠæ ‡é¢˜ä¸­çš„åœ¨çº¿äººæ•°
            document.querySelector('.online-count').textContent = `(${online}/${total})`;
            
            // æ›´æ–°åœ¨çº¿æˆå‘˜å¤´åƒç½‘æ ¼
            updateMemberGrid(filteredUsers);
        }

        // æ·»åŠ  updateMemberGrid å‡½æ•°
        function updateMemberGrid(users) {
            const grid = document.getElementById('online-members-grid');
            grid.innerHTML = users.map(user => {
                // ä»localStorageè·å–ç”¨æˆ·ä¿¡æ¯
                let avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${user}`;
                const savedInfo = localStorage.getItem(user);
                if (savedInfo) {
                    const userInfo = JSON.parse(savedInfo);
                    if (userInfo.avatar) {
                        avatarUrl = userInfo.avatar;
                    }
                }
                
                return `
                    <div class="member-item" onclick="startPrivateChat('${user}')">
                        <img src="${avatarUrl}" alt="${user}" class="member-avatar">
                        <span class="member-name">${user}</span>
                    </div>
                `;
            }).join('');
        }

        // ç§»é™¤è¡¨æƒ…æŒ‰é’®çš„alertäº‹ä»¶ç›‘å¬
        document.querySelector('.bi-emoji-smile').parentElement.removeEventListener('click', () => {
            alert('è¡¨æƒ…åŠŸèƒ½å¼€å‘ä¸­...');
        });

        // ä¿®æ”¹è¡¨æƒ…é€‰æ‹©å™¨åŠŸèƒ½
        const emojiData = {
            smileys: ['ğŸ˜€', 'ğŸ˜‚', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜…', 'ï¿½ï¿½ï¿½ï¿½', 'ï¿½ï¿½ï¿½ï¿½', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', ''],
            animals: ['ğŸ¶', 'ğŸ±', 'ğŸ°', 'ğŸ¹', 'ğŸ°', '', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ'],
            food: ['ğŸ', 'ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ‰', 'ğŸ‡', 'ğŸ“', 'ğŸˆ', 'ğŸ’', 'ğŸ‘', 'ğŸ¥­', 'ğŸ', 'ğŸ¥¥', 'ğŸ¥'],
            activities: ['âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¥', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ±', 'ğŸ“', 'ğŸ¸', 'ğŸ’', 'ğŸ‘', 'ğŸ¥', 'ğŸ'],
            objects: ['', 'ğŸ’»', 'âŒš', 'ğŸ“·', '', 'ğŸ“¹', 'ğŸ¥', 'ğŸ“½', 'ğŸ', '', 'â˜ï¸', 'ğŸ“Ÿ', 'ğŸ“ ', 'ğŸ“º', 'ğŸ“»']
        };

        let recentEmojis = JSON.parse(localStorage.getItem('recentEmojis') || '[]');

        function toggleEmojiPicker() {
            const picker = document.getElementById('emoji-picker');
            const messageInput = document.querySelector('.message-input');
            
            if (picker.style.display === 'none') {
                // æ˜¾ç¤ºè¡¨æƒ…é€‰æ‹©å™¨
                picker.style.display = 'block';
                
                // å®šä½è¡¨æƒ…é€‰æ‹©å™¨
                const inputRect = messageInput.getBoundingClientRect();
                picker.style.position = 'absolute';
                picker.style.bottom = (window.innerHeight - inputRect.top + 10) + 'px';
                picker.style.left = inputRect.left + 'px';
                
                // é»˜è®¤æ˜¾ç¤ºæœ€ä½¿ç”¨çš„è¡¨æƒ…
                updateEmojiList('recent');
                
                // æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­åŠŸèƒ½
                document.addEventListener('click', closeEmojiPickerOnClickOutside);
            } else {
                closeEmojiPicker();
            }
        }

        function closeEmojiPicker() {
            const picker = document.getElementById('emoji-picker');
            picker.style.display = 'none';
            document.removeEventListener('click', closeEmojiPickerOnClickOutside);
        }

        function closeEmojiPickerOnClickOutside(event) {
            const picker = document.getElementById('emoji-picker');
            const emojiButton = document.querySelector('.bi-emoji-smile').parentElement;
            
            if (!picker.contains(event.target) && !emojiButton.contains(event.target)) {
                closeEmojiPicker();
            }
        }

        function switchEmojiCategory(category) {
            // æ›´æ–°åˆ†ç±»æŒ‰çŠ¶æ€
            document.querySelectorAll('.emoji-categories button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // æ›´æ–°è¡¨æƒ…åˆ—è¡¨
            updateEmojiList(category);
        }

        function updateEmojiList(category) {
            const list = document.getElementById('emoji-list');
            const emojis = category === 'recent' ? recentEmojis : emojiData[category];
            
            list.innerHTML = emojis.map(emoji => `
                <button class="emoji-btn" onclick="insertEmoji('${emoji}')">${emoji}</button>
            `).join('');
        }

        function insertEmoji(emoji) {
            const messageInput = document.getElementById('message-input');
            const cursorPos = messageInput.selectionStart;
            const text = messageInput.value;
            
            // åœ¨å…‰æ ‡ä½ç½®æ’å…¥è¡¨æƒ…
            messageInput.value = text.slice(0, cursorPos) + emoji + text.slice(cursorPos);
            
            // æ›´æ–°å…‰æ ‡ä½ç½®
            const newCursorPos = cursorPos + emoji.length;
            messageInput.setSelectionRange(newCursorPos, newCursorPos);
            
            // æ›´æ–°æœ€è¿‘ä½¿ç”¨çš„è¡¨æƒ…
            recentEmojis = [emoji, ...recentEmojis.filter(e => e !== emoji)].slice(0, 15);
            localStorage.setItem('recentEmojis', JSON.stringify(recentEmojis));
            
            // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯æœ€è¿‘ä½¿ç”¨çš„è¡¨æƒ…ï¼Œæ›´æ–°åˆ—è¡¨
            if (document.querySelector('.emoji-categories button.active').textContent === 'æœ€è¿‘') {
                updateEmojiList('recent');
            }
            
            // èšç„¦è¾“å…¥æ¡†
            messageInput.focus();
        }

        // å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
        function openImageUpload() {
            document.getElementById('image-upload').click();
        }

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const imageData = e.target.result;
                    // åœ¨è¾“å…¥æ¡†ä¸­æ’å…¥å›¾ç‰‡çš„ Markdown è¯­æ³•
                    const messageInput = document.getElementById('message-input');
                    const cursorPosition = messageInput.selectionStart;
                    const text = messageInput.value;
                    const imageMarkdown = `![${file.name}](${imageData})`;
                    
                    messageInput.value = text.slice(0, cursorPosition) + imageMarkdown + text.slice(cursorPosition);
                    
                    // æ›´æ–°å…‰æ ‡ä½ç½®
                    const newPosition = cursorPosition + imageMarkdown.length;
                    messageInput.setSelectionRange(newPosition, newPosition);
                    messageInput.focus();
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
                showToast('å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
            }
        }

        // æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
        function openFileUpload() {
            document.getElementById('file-upload').click();
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                // å‘é€æ–‡ä»¶æ¶ˆæ¯
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'file',
                        filename: file.name,
                        size: file.size,
                        contentType: file.type
                    }));
                }
            } catch (error) {
                console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
                showToast('æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
            }
        }

        // æ¶ˆæ¯æœç´¢åŠŸèƒ½
        function openMessageSearch() {
            document.getElementById('message-search-panel').style.display = 'block';
            document.getElementById('message-search-input').focus();
        }

        function closeMessageSearch() {
            document.getElementById('message-search-panel').style.display = 'none';
        }

        function searchMessages() {
            const searchInput = document.getElementById('message-search-input');
            const searchTerm = searchInput.value.toLowerCase();
            const messages = document.querySelectorAll('.message:not(.system)');
            const results = [];
            
            messages.forEach(message => {
                const content = message.querySelector('.message-content').textContent.toLowerCase();
                if (content.includes(searchTerm)) {
                    results.push({
                        content: message.querySelector('.message-content').textContent,
                        username: message.querySelector('.username').textContent || currentUsername,
                        timestamp: message.previousElementSibling?.classList.contains('timestamp') 
                            ? message.previousElementSibling.textContent 
                            : 'æœªçŸ¥æ—¶é—´'
                    });
                }
            });
            
            displaySearchResults(results);
        }

        function displaySearchResults(results) {
            const resultsContainer = document.getElementById('message-search-results');
            resultsContainer.innerHTML = results.map(result => `
                <div class="search-result">
                    <div class="result-header">
                        <span class="result-username">${result.username}</span>
                        <span class="result-time">${result.timestamp}</span>
                    </div>
                    <div class="result-content">${result.content}</div>
                </div>
            `).join('') || '<div class="no-results">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ¶ˆæ¯</div>';
        }

        // ç¾¤å…¬å‘Šç¼–è¾‘åŠŸèƒ½
        function openAnnouncementEditor() {
            const currentAnnouncement = document.querySelector('.announcement-content').textContent;
            document.getElementById('announcement-text').value = currentAnnouncement;
            document.getElementById('announcement-editor').style.display = 'flex';
        }

        function closeAnnouncementEditor() {
            document.getElementById('announcement-editor').style.display = 'none';
        }

        function saveAnnouncement() {
            const newAnnouncement = document.getElementById('announcement-text').value.trim();
            if (!newAnnouncement) {
                showToast('å…¬å‘Šå®¹ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'announcement',
                    content: newAnnouncement
                }));
                closeAnnouncementEditor();
            }
        }

        // æ·»åŠ å›¾ç‰‡æ¶ˆæ¯
        function addImageMessage(data) {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${data.username === currentUsername ? 'own' : 'other'}`;
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${data.username}" 
                         alt="${data.username}" class="message-avatar">
                    <span class="username">${data.username === currentUsername ? '' : data.username}</span>
                </div>
                <div class="message-content image-content">
                    <img src="${data.content}" alt="å›¾ç‰‡æ¶ˆæ¯" onclick="previewImage('${data.content}')">
                </div>
            `;
            
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        // æ·»åŠ æ–‡ä»¶æ¶ˆæ¯
        function addFileMessage(data) {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${data.username === currentUsername ? 'own' : 'other'}`;
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${data.username}" 
                         alt="${data.username}" class="message-avatar">
                    <span class="username">${data.username === currentUsername ? '' : data.username}</span>
                </div>
                <div class="message-content file-content">
                    <i class="bi bi-file-earmark"></i>
                    <div class="file-info">
                        <span class="file-name">${data.filename}</span>
                        <span class="file-size">${formatFileSize(data.size)}</span>
                    </div>
                    <button onclick="downloadFile('${data.url}')" class="download-btn">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
            `;
            
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        // æ›´æ–°ç¾¤å…¬å‘Š
        function updateAnnouncement(content) {
            document.querySelector('.announcement-content').textContent = content;
            showToast('å…¬å‘Šå·²æ›´æ–°');
        }

        // å·¥å…·å‡½æ•°
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }

        function previewImage(url) {
            const modal = document.createElement('div');
            modal.className = 'image-preview-modal';
            modal.innerHTML = `
                <div class="preview-content">
                    <img src="${url}" alt="é¢„è§ˆå›¾ç‰‡">
                    <button class="close-preview" onclick="this.parentElement.parentElement.remove()">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // æ·»åŠ  @ æé†’åŠŸèƒ½
        function setupMentionFeature() {
            const messageInput = document.getElementById('message-input');
            const mentionPanel = document.createElement('div');
            mentionPanel.className = 'mention-panel';
            mentionPanel.style.display = 'none';
            document.querySelector('.message-input-container').appendChild(mentionPanel);

            let mentionStart = -1;
            let mentionText = '';

            messageInput.addEventListener('input', (e) => {
                const text = e.target.value;
                const caretPos = e.target.selectionStart;
                
                // æ£€æŸ¥æ˜¯å¦æ­£åœ¨è¾“å…¥ @
                if (text[caretPos - 1] === '@') {
                    mentionStart = caretPos - 1;
                    mentionText = '';
                    showMentionPanel('');
                } else if (mentionStart !== -1 && caretPos > mentionStart) {
                    // æ›´æ–°æœç´¢æ–‡æœ¬
                    mentionText = text.substring(mentionStart + 1, caretPos);
                    showMentionPanel(mentionText);
                } else {
                    mentionStart = -1;
                    mentionPanel.style.display = 'none';
                }
            });

            function handleMentionKeydown(e) {
                if (mentionPanel.style.display === 'none') return;
                
                const selectedItem = mentionPanel.querySelector('.mention-item.selected');
                
                switch (e.key) {
                    case 'ArrowUp':
                        e.preventDefault();
                        e.stopPropagation();
                        selectPrevMention();
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        e.stopPropagation();
                        selectNextMention();
                        break;
                    case 'Enter':
                    case 'Tab':
                        if (selectedItem) {
                            e.preventDefault();
                            e.stopPropagation();
                            insertMention(selectedItem.dataset.username);
                            return false;
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        e.stopPropagation();
                        mentionPanel.style.display = 'none';
                        mentionStart = -1;
                        break;
                }
            }

            // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
            messageInput.removeEventListener('keydown', handleMentionKeydown);
            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨å¹¶ç¡®ä¿å®ƒåœ¨å…¶ä»– keydown äº‹ä»¶ä¹‹å‰è§¦å‘
            messageInput.addEventListener('keydown', handleMentionKeydown, true);

            function showMentionPanel(searchText) {
                const users = Array.from(document.querySelectorAll('#users .member-name'))
                    .map(el => el.textContent)
                    .filter(name => name.toLowerCase().includes(searchText.toLowerCase()));
                
                // å¦‚æœå°åŠ©æ‰‹ä¸åœ¨åˆ—è¡¨ä¸­æ‰æ·»åŠ 
                if (!users.includes('å°åŠ©æ‰‹')) {
                    users.unshift('å°åŠ©æ‰‹');
                }
                
                if (users.length === 0) {
                    mentionPanel.style.display = 'none';
                    return;
                }

                mentionPanel.innerHTML = users.map((user, index) => `
                    <div class="mention-item ${index === 0 ? 'selected' : ''}" data-username="${user}">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${user}" 
                             alt="${user}" class="mention-avatar">
                        <span>${user}</span>
                    </div>
                `).join('');

                // å®šä½é¢æ¿
                const inputRect = messageInput.getBoundingClientRect();
                const caretCoords = getCaretCoordinates(messageInput, mentionStart);
                
                mentionPanel.style.display = 'block';
                mentionPanel.style.position = 'absolute';
                
                // è®¡ç®—é¢æ¿ä½ç½®
                const panelLeft = inputRect.left + 12; // æ·»åŠ ä¸€äº›å·¦è¾¹è·
                const panelTop = inputRect.top - mentionPanel.offsetHeight - 5; // åœ¨è¾“å…¥æ¡†ä¸Šæ–¹æ˜¾ç¤ºï¼Œæ·»åŠ ä¸€äº›é—´è·
                
                // ç¡®ä¿é¢æ¿ä¸ä¼šè¶…å‡ºè§†å£
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                
                // è°ƒæ•´æ°´å¹³ä½ç½®
                if (panelLeft + mentionPanel.offsetWidth > viewportWidth) {
                    mentionPanel.style.left = (viewportWidth - mentionPanel.offsetWidth - 10) + 'px';
                } else {
                    mentionPanel.style.left = panelLeft + 'px';
                }
                
                // è°ƒæ•´å‚ç›´ä½ç½®
                if (panelTop < 0) {
                    // å¦‚æœä¸Šæ–¹ç©ºé—´ä¸å¤Ÿï¼Œå°±æ˜¾ç¤ºåœ¨è¾“å…¥æ¡†ä¸‹
                    mentionPanel.style.top = (inputRect.bottom + 5) + 'px';
                } else {
                    mentionPanel.style.top = panelTop + 'px';
                }

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                mentionPanel.querySelectorAll('.mention-item').forEach(item => {
                    item.addEventListener('click', () => {
                        insertMention(item.dataset.username);
                    });
                    
                    item.addEventListener('mouseover', () => {
                        mentionPanel.querySelectorAll('.mention-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                    });
                });
            }

            function selectNextMention() {
                const items = mentionPanel.querySelectorAll('.mention-item');
                const selectedIndex = Array.from(items).findIndex(item => item.classList.contains('selected'));
                items[selectedIndex]?.classList.remove('selected');
                items[(selectedIndex + 1) % items.length]?.classList.add('selected');
            }

            function selectPrevMention() {
                const items = mentionPanel.querySelectorAll('.mention-item');
                const selectedIndex = Array.from(items).findIndex(item => item.classList.contains('selected'));
                items[selectedIndex]?.classList.remove('selected');
                const newIndex = selectedIndex <= 0 ? items.length - 1 : selectedIndex - 1;
                items[newIndex]?.classList.add('selected');
            }

            function insertMention(username) {
                const text = messageInput.value;
                const newText = text.substring(0, mentionStart) + '@' + username + ' ' + text.substring(messageInput.selectionStart);
                messageInput.value = newText;
                messageInput.focus();
                const cursorPos = mentionStart + username.length + 2;
                messageInput.setSelectionRange(cursorPos, cursorPos);
                mentionPanel.style.display = 'none';
                mentionStart = -1;
            }
        }

        // æ·»åŠ è·å–å…‰æ ‡ä½ç½®çš„è¾…åŠ©å‡½æ•°
        function getCaretCoordinates(element, position) {
            const div = document.createElement('div');
            const style = getComputedStyle(element);
            const properties = [
                'fontFamily', 'fontSize', 'fontWeight', 'fontStyle',
                'letterSpacing', 'textTransform', 'wordSpacing', 'textIndent',
                'whiteSpace', 'wordBreak', 'wordWrap', 'lineHeight',
                'paddingTop', 'paddingRight', 'paddingBottom', 'paddingLeft',
                'borderTopWidth', 'borderRightWidth', 'borderBottomWidth', 'borderLeftWidth'
            ];

            properties.forEach(prop => {
                div.style[prop] = style[prop];
            });

            div.textContent = element.value.substring(0, position);
            div.style.position = 'absolute';
            div.style.visibility = 'hidden';
            div.style.whiteSpace = 'pre-wrap';
            div.style.width = element.offsetWidth + 'px';
            
            document.body.appendChild(div);
            const coordinates = {
                left: div.offsetWidth,
                top: div.offsetHeight
            };
            document.body.removeChild(div);
            
            return coordinates;
        }

        // ç›‘å¬ç”¨æˆ·åè¾“å…¥æ¡†çš„å›è½¦é”®
        document.getElementById('username-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                joinChat();
            }
        });

        // ç¾¤è®¾ç½®ç›¸å…³å‡½æ•°
        function openGroupSettingsEditor() {
            const modal = document.getElementById('group-settings-editor');
            const nameInput = document.getElementById('group-name-input');
            nameInput.value = document.getElementById('group-name').textContent;
            modal.style.display = 'flex';
        }

        function closeGroupSettingsEditor() {
            document.getElementById('group-settings-editor').style.display = 'none';
        }

        function saveGroupSettings() {
            const newName = document.getElementById('group-name-input').value.trim();
            
            if (!newName) {
                showToast('ç¾¤åç§°ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'group_settings',
                    name: newName
                }));
                
                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                document.getElementById('group-name').textContent = newName;
                document.querySelector('#groups .member-name').textContent = newName;
                document.querySelector('.chat-title span').textContent = newName;
                
                closeGroupSettingsEditor();
                showToast('ç¾¤è®¾ç½®å·²æ›´æ–°');
            }
        }

        // ä¿®æ”¹æˆå‘˜æ•°é‡æ˜¾ç¤º
        function updateMemberCount(users) {
            const filteredUsers = users.filter(user => user !== 'å°åŠ©æ‰‹');
            const total = filteredUsers.length;
            const online = filteredUsers.length; // ç›®å‰åœ¨çº¿äººæ•°ç­‰äºæ€»äººæ•°
            
            // æ›´æ–°ç¾¤ä¿¡æ¯ä¸­çš„æˆå‘˜æ•°
            document.querySelector('.member-count .count').textContent = `${total}`;
            // æ›´æ–°ç¾¤èŠæ ‡é¢˜ä¸­çš„åœ¨çº¿äººæ•°
            document.querySelector('.online-count').textContent = `(${online}/${total})`;
            
            // æ›´æ–°åœ¨çº¿æˆå‘˜å¤´åƒç½‘æ ¼
            updateMemberGrid(filteredUsers);
        }

        // ä¿®æ”¹ updateUserList å‡½æ•°
        function updateUserList(users) {
            const userList = document.getElementById('users');
            const filteredUsers = users.filter(user => user !== currentUsername);
            
            // ç”Ÿæˆç”¨æˆ·åˆ—è¡¨HTML
            userList.innerHTML = filteredUsers.map(user => {
                const userStatus = localStorage.getItem(`userStatus_${user}`) || '';
                return `
                    <li class="member-item" onclick="startPrivateChat('${user}')">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${user}" alt="${user}" class="member-avatar">
                        <div class="member-info">
                            <span class="member-name">${user}</span>
                            <div class="member-details">
                                <span class="member-status">${userStatus || 'åœ¨çº¿'}</span>
                                <span class="online-time">åˆšåˆšæ´»è·ƒ</span>
                            </div>
                        </div>
                    </li>
                `;
            }).join('');
            
            // æ›´æ–°æˆå‘˜æ•°é‡
            updateMemberCount(users);
            
            // æ›´æ–°å½“å‰ç”¨æˆ·æ˜¾ç¤º
            updateMyInfo();
            
            // æ›´æ–°æœ€è¿‘èŠå¤©åˆ—è¡¨
            updateRecentChats();
        }

        // æ·»åŠ ç¾¤è®¾ç½®æ›´æ–°å¤„ç†å‡½æ•°
        function updateGroupSettings(data) {
            if (data.name) {
                document.getElementById('group-name').textContent = data.name;
                document.querySelector('#groups .member-name').textContent = data.name;
                document.querySelector('.chat-title span').textContent = data.name;
                showToast('ç¾¤è®¾ç½®å·²æ›´æ–°');
            }
        }

        // ä¿®æ”¹ switchTab å‡½æ•°
        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab-btn');
            const chatsTab = document.getElementById('chats-tab');
            const contactsTab = document.getElementById('contacts-tab');
            
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
            tabs.forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab-btn[onclick*="${tab}"]`).classList.add('active');
            
            // åˆ‡æ¢å®¹åŒºåŸŸ
            if (tab === 'chats') {
                chatsTab.style.display = 'flex';
                contactsTab.style.display = 'none';
                updateRecentChats();
            } else if (tab === 'contacts') {
                chatsTab.style.display = 'none';
                contactsTab.style.display = 'flex';
                updateMyInfo();
            }
        }

        // ä¿®æ”¹ updateRecentChats å‡½æ•°
        function updateRecentChats(newChat = null) {
            const recentChats = document.getElementById('recent-chats');
            let recentList = JSON.parse(localStorage.getItem('recentChats') || '[]');
            
            // å¦‚æœæœ‰æ–°çš„èŠå¤©ï¼Œæ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´
            if (newChat && !recentList.includes(newChat)) {
                recentList.unshift(newChat);
                recentList = recentList.slice(0, 5); // ä¿ç•™æœ€è¿‘5ä¸ª
                localStorage.setItem('recentChats', JSON.stringify(recentList));
            }
            
            recentChats.innerHTML = recentList.map(username => `
                <li class="member-item" onclick="startPrivateChat('${username}')">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${username}" alt="${username}" class="member-avatar">
                    <div class="member-info">
                        <span class="member-name">${username}</span>
                        <div class="member-details">
                            <span class="member-status">ç‚¹å‡»ç»­èŠå¤©</span>
                            <span class="online-time">åœ¨çº¿</span>
                        </div>
                    </div>
                </li>
            `).join('');
        }

        // åˆå§‹åŒ– Markdown è®¾ç½®
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (err) {}
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        // æ’å…¥ Markdown è¯­æ³•
        function insertMarkdown(prefix, suffix, isImage = false) {
            const input = document.getElementById('message-input');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            const selection = text.substring(start, end);
            
            let insertion = '';
            if (isImage) {
                insertion = '![å›¾ç‰‡æè¿°](å›¾ç‰‡URL)';
            } else {
                insertion = prefix + selection + suffix;
            }
            
            input.value = text.substring(0, start) + insertion + text.substring(end);
            input.focus();
            
            // è®¾ç½®å…‰æ ‡ä½ç½®
            if (selection) {
                input.setSelectionRange(start + prefix.length, start + prefix.length + selection.length);
            } else {
                input.setSelectionRange(start + prefix.length, start + insertion.length - suffix.length);
            }
        }

        // æ·»åŠ æ–°çš„å‡½æ•°
        function openMentionPanel() {
            const messageInput = document.getElementById('message-input');
            const cursorPosition = messageInput.selectionStart;
            
            // åœ¨å…‰æ ‡ä½ç½®æ’å…¥ @ ç¬¦å·
            const text = messageInput.value;
            messageInput.value = text.slice(0, cursorPosition) + '@' + text.slice(cursorPosition);
            
            // è®¾ç½®å…‰æ ‡ä½ç½®
            messageInput.selectionStart = cursorPosition + 1;
            messageInput.selectionEnd = cursorPosition + 1;
            
            // è§¦å‘ @ é¢æ¿
            messageInput.dispatchEvent(new InputEvent('input'));
            messageInput.focus();
        }

        function insertNewline() {
            const messageInput = document.getElementById('message-input');
            const cursorPosition = messageInput.selectionStart;
            const text = messageInput.value;
            
            // åœ¨å…‰æ ‡ä½ï¿½ï¿½ï¿½æ’å…¥æ¢è¡Œç¬¦
            messageInput.value = text.slice(0, cursorPosition) + '\n' + text.slice(cursorPosition);
            
            // è®¾ç½®å…‰æ ‡ä½ç½®
            messageInput.selectionStart = cursorPosition + 1;
            messageInput.selectionEnd = cursorPosition + 1;
            messageInput.focus();
        }

        // æ·»åŠ è¯­éŸ³æ¶ˆæ¯åŠŸèƒ½
        function startVoiceMessage() {
            alert('è¯­éŸ³åŠŸèƒ½å¼€å‘ä¸­...');
        }

        // åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ– highlight.js
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightBlock(block);
            });
        });

        // åœ¨æ·»åŠ æ–°æ¶ˆæ¯åä¹Ÿè¦é«˜äº®ä»£ç å—
        const originalAddMessage = addMessage;
        addMessage = function(data) {
            originalAddMessage(data);
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightBlock(block);
            });
        };

        // æ·»åŠ ä¿å­˜ä¸ªäººä¿¡æ¯çš„å‡½æ•°
        function saveProfile() {
            const newUsername = document.getElementById('profile-username').value.trim();
            const newStatus = document.getElementById('profile-status').value.trim();
            const newAvatar = document.getElementById('current-avatar').src;
            
            // æ›´æ–°ä¸ªæ€§ç­¾åï¼ˆåŒæ—¶æ›´æ–°é¡¶éƒ¨å’Œå·¦ä¾§çš„çŠ¶æ€æ–‡æœ¬ï¼‰
            if (newStatus) {
                // æ›´æ–°å·¦ä¾§è”ç³»äººåˆ—è¡¨ä¸­çš„çŠ¶æ€
                document.getElementById('my-status').textContent = newStatus;
                // æ›´æ–°é¡¶éƒ¨çš„çŠ¶æ€æ–‡æœ¬
                document.querySelector('.status-text').textContent = newStatus;
            }
            
            // æ›´æ–°å¤´åƒ
            document.querySelector('.current-user .avatar').src = newAvatar;
            document.getElementById('my-avatar').src = newAvatar;
            
            // æ›´æ–°ç”¨æˆ·åï¼ˆå¦‚æœæœ‰ä¿®æ”¹ï¼‰
            if (newUsername && newUsername !== currentUsername) {
                // è¿™é‡Œå¯ä»¥æ·»åŠ ä¿®æ”¹ç”¨æˆ·åçš„é€»è¾‘
                console.log('ç”¨æˆ·åä¿®æ”¹åŠŸèƒ½æš‚æœªå®ç°');
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const userInfo = {
                username: currentUsername,
                avatar: newAvatar,
                status: newStatus || document.querySelector('.status-text').textContent
            };
            localStorage.setItem(currentUsername, JSON.stringify(userInfo));
            
            // å…³é—­æ¨¡æ€æ¡†
            closeProfileModal();
            
            // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
            showToast('ä¸ªäººä¿¡æ¯å·²æ›´æ–°');
        }

        // æ‰“å¼€ä¸ªäººä¿¡æ¯ç¼–è¾‘æ¨¡æ€æ¡†
        function openProfileModal() {
            const modal = document.getElementById('profile-modal');
            const usernameInput = document.getElementById('profile-username');
            const statusInput = document.getElementById('profile-status');
            
            // å¡«å……å½“å‰ä¿¡æ¯
            usernameInput.value = currentUsername;
            // ä»å·¦ä¾§è”ç³»äººåˆ—è¡¨è·å–å½“å‰çŠ¶æ€æ–‡æœ¬
            const currentStatus = document.getElementById('my-status').textContent;
            statusInput.value = currentStatus === 'ç‚¹å‡»ç¼–è¾‘ä¸ªäººä¿¡æ¯' ? '' : currentStatus;
            
            modal.style.display = 'flex';
        }

        // å…³é—­ä¸ªäººä¿¡æ¯ç¼–è¾‘æ¨¡æ€æ¡†
        function closeProfileModal() {
            document.getElementById('profile-modal').style.display = 'none';
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message) {
            // ç§»é™¤ç°æœ‰çš„æç¤ºæ¶ˆæ¯
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // åˆ›å»ºæ–°çš„æç¤ºæ¶ˆæ¯
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 2ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                toast.remove();
            }, 2000);
        }

        // æ·»åŠ æ›´æ¢å¤´åƒçš„å‡½æ•°
        function changeAvatar() {
            // ç”Ÿæˆä¸€ä¸ªéšæœºç§å­
            const randomSeed = Math.random().toString(36).substring(7);
            const newAvatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${randomSeed}`;
            
            // æ›´æ–°ä¸ªäººä¿¡æ¯æ¨¡æ€æ¡†ä¸­çš„å¤´åƒ
            document.getElementById('current-avatar').src = newAvatarUrl;
            
            // æ›´æ–°é¡¶éƒ¨çš„å¤´åƒ
            document.querySelector('.current-user .avatar').src = newAvatarUrl;
            
            // æ›´æ–°å·¦ä¾§è”ç³»äººåˆ—è¡¨ä¸­çš„å¤´åƒ
            document.getElementById('my-avatar').src = newAvatarUrl;
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const userInfo = {
                username: currentUsername,
                avatar: newAvatarUrl,
                status: document.querySelector('.status-text').textContent
            };
            localStorage.setItem(currentUsername, JSON.stringify(userInfo));
            
            // é€šçŸ¥åç«¯æ›´æ–°äº†å¤´åƒ
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'avatar_update',
                    username: currentUsername,
                    avatar: newAvatarUrl
                }));
            }
            
            // æ›´æ–°ç¾¤èŠåœ¨çº¿æˆå‘˜åˆ—è¡¨
            const grid = document.getElementById('online-members-grid');
            const memberItems = grid.querySelectorAll('.member-item');
            memberItems.forEach(item => {
                const username = item.querySelector('.member-name').textContent;
                if (username === currentUsername) {
                    item.querySelector('.member-avatar').src = newAvatarUrl;
                }
            });
            
            // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
            showToast('å¤´åƒå·²æ›´æ–°');
        }
    </script>
</body>
</html>
